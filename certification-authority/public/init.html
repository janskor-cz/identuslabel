<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wallet Initialization - Certification Authority</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 600px;
      width: 100%;
      padding: 40px;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .header h1 {
      color: #2d3748;
      font-size: 28px;
      margin-bottom: 10px;
    }

    .header p {
      color: #718096;
      font-size: 16px;
    }

    .warning-box {
      background: #fff5f5;
      border-left: 4px solid #f56565;
      padding: 15px;
      margin-bottom: 25px;
      border-radius: 4px;
    }

    .warning-box strong {
      color: #c53030;
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .warning-box p {
      color: #742a2a;
      font-size: 14px;
      line-height: 1.6;
    }

    .qr-section {
      text-align: center;
      margin: 30px 0;
    }

    #qrcode {
      display: inline-block;
      padding: 20px;
      background: white;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .loading {
      color: #718096;
      font-size: 16px;
      padding: 40px;
    }

    .ca-info {
      background: #f7fafc;
      border-radius: 8px;
      padding: 20px;
      margin-top: 25px;
    }

    .ca-info h3 {
      color: #2d3748;
      font-size: 18px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .info-row {
      display: flex;
      padding: 10px 0;
      border-bottom: 1px solid #e2e8f0;
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      font-weight: 600;
      color: #4a5568;
      min-width: 160px;
      font-size: 14px;
    }

    .info-value {
      color: #2d3748;
      font-size: 14px;
      word-break: break-word;
    }

    .did-value {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: #4a5568;
      background: white;
      padding: 8px;
      border-radius: 4px;
      overflow-wrap: anywhere;
    }

    .instructions {
      background: #ebf8ff;
      border-left: 4px solid #3182ce;
      padding: 15px;
      margin-top: 25px;
      border-radius: 4px;
    }

    .instructions h4 {
      color: #2c5282;
      font-size: 16px;
      margin-bottom: 10px;
    }

    .instructions ol {
      color: #2c5282;
      font-size: 14px;
      line-height: 1.8;
      padding-left: 20px;
    }

    .instructions li {
      margin-bottom: 8px;
    }

    .badge {
      display: inline-block;
      background: #48bb78;
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
    }

    .error {
      background: #fed7d7;
      color: #9b2c2c;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      text-align: center;
    }

    .copy-section {
      text-align: center;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 2px solid #e2e8f0;
    }

    .copy-section p {
      color: #718096;
      font-size: 14px;
      margin-bottom: 15px;
    }

    .copy-button {
      background: #4299e1;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 6px rgba(66, 153, 225, 0.3);
    }

    .copy-button:hover {
      background: #3182ce;
      box-shadow: 0 6px 8px rgba(66, 153, 225, 0.4);
      transform: translateY(-2px);
    }

    .copy-button:active {
      transform: translateY(0);
    }

    .copy-button.copied {
      background: #48bb78;
    }

    .copy-button.copied:hover {
      background: #38a169;
    }

    @media (max-width: 640px) {
      .container {
        padding: 25px;
      }

      .header h1 {
        font-size: 24px;
      }

      .info-row {
        flex-direction: column;
        gap: 5px;
      }

      .info-label {
        min-width: auto;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üèõÔ∏è Connect to Certification Authority</h1>
      <p>Initialize your wallet with verified CA identity</p>
    </div>

    <div class="warning-box">
      <strong>‚ö†Ô∏è SECURITY: Verify this URL before scanning</strong>
      <p>
        Ensure your browser address bar shows: <strong>https://identuslabel.cz/wallet-init</strong>
        <br>
        Do not scan QR codes from untrusted websites or emails.
      </p>
    </div>

    <div class="qr-section">
      <div id="qrcode">
        <div class="loading">Loading CA invitation...</div>
      </div>

      <!-- Copy button for users without cameras -->
      <div class="copy-section" id="copySection" style="display: none;">
        <p>üìã No camera? Copy the invitation URL manually:</p>
        <button class="copy-button" id="copyButton" onclick="copyInvitationUrl()">
          Copy Invitation URL
        </button>
        <input type="hidden" id="invitationUrlHidden" value="">
      </div>
    </div>

    <div class="ca-info" id="caInfo" style="display: none;">
      <h3>
        üìã Certification Authority Details
        <span class="badge">VERIFIED</span>
      </h3>
      <div class="info-row">
        <div class="info-label">Organization:</div>
        <div class="info-value" id="orgName">-</div>
      </div>
      <div class="info-row">
        <div class="info-label">Website:</div>
        <div class="info-value" id="website">-</div>
      </div>
      <div class="info-row">
        <div class="info-label">Jurisdiction:</div>
        <div class="info-value" id="jurisdiction">-</div>
      </div>
      <div class="info-row">
        <div class="info-label">Registration:</div>
        <div class="info-value" id="registration">-</div>
      </div>
      <div class="info-row">
        <div class="info-label">Authority Level:</div>
        <div class="info-value" id="authorityLevel">-</div>
      </div>
      <div class="info-row">
        <div class="info-label">DID:</div>
        <div class="did-value" id="holderDID">-</div>
      </div>
    </div>

    <div class="instructions">
      <h4>üì± How to Initialize Your Wallet:</h4>
      <ol>
        <li><strong>Verify</strong> the URL in your browser address bar matches the website above</li>
        <li><strong>Open</strong> your Edge Wallet (Alice or Bob) on this device</li>
        <li><strong>Look for</strong> the "Connect to CA" button or modal on first launch</li>
        <li><strong>Scan</strong> the QR code with your wallet camera</li>
        <li><strong>Review</strong> the CA details shown in your wallet</li>
        <li><strong>Accept</strong> the connection to establish trust</li>
      </ol>
    </div>

    <div id="error" class="error" style="display: none;"></div>
  </div>

  <!-- QR Code library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script>
    async function loadCAInvitation() {
      try {
        // Fetch CA invitation from backend
        const response = await fetch('/api/wallet-init/ca-invitation');

        if (!response.ok) {
          throw new Error(`Failed to load CA invitation: ${response.status}`);
        }

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to generate CA invitation');
        }

        console.log('‚úÖ CA invitation loaded:', data.caInfo.organizationName);
        console.log('üìè Invitation URL length:', data.invitationUrl.length, 'chars');
        console.log('üìè Short URL length:', data.shortUrl?.length || 'N/A', 'chars');

        // Generate QR code using short URL (much smaller than full invitation)
        document.getElementById('qrcode').innerHTML = '';
        const qrUrl = data.shortUrl || data.invitationUrl; // Fallback to full URL if short URL not available

        console.log('üîó Using URL for QR code:', qrUrl);

        try {
          new QRCode(document.getElementById('qrcode'), {
            text: qrUrl,
            width: 300,
            height: 300,
            colorDark: '#000000',
            colorLight: '#ffffff',
            correctLevel: QRCode.CorrectLevel.M  // Medium error correction for short URLs
          });
          console.log('‚úÖ QR code generated successfully');
        } catch (qrError) {
          console.error('‚ùå QR code generation failed:', qrError);
          // Fallback: create a link instead
          document.getElementById('qrcode').innerHTML = `
            <div style="padding: 20px; text-align: center;">
              <p style="color: #e53e3e; margin-bottom: 10px;">‚ö†Ô∏è QR code generation failed</p>
              <p style="font-size: 14px; color: #4a5568;">URL length: ${qrUrl.length} chars</p>
              <button onclick="navigator.clipboard.writeText('${qrUrl.replace(/'/g, "\\'")}'); alert('Invitation URL copied!');"
                      style="margin-top: 10px; padding: 10px 20px; background: #4299e1; color: white; border: none; border-radius: 6px; cursor: pointer;">
                üìã Copy Invitation URL
              </button>
            </div>
          `;
          throw qrError;
        }

        // Display CA information
        document.getElementById('orgName').textContent = data.caInfo.organizationName;
        document.getElementById('website').textContent = data.caInfo.website;
        document.getElementById('jurisdiction').textContent = data.caInfo.jurisdiction;
        document.getElementById('registration').textContent = data.caInfo.registrationNumber;
        document.getElementById('authorityLevel').textContent = data.caInfo.authorityLevel;

        // Format DID for display (show first and last parts)
        const did = data.caInfo.holderDID;
        const didShort = did.length > 80
          ? `${did.substring(0, 40)}...${did.substring(did.length - 40)}`
          : did;
        document.getElementById('holderDID').textContent = didShort;
        document.getElementById('holderDID').title = did; // Full DID on hover

        // Show CA info section
        document.getElementById('caInfo').style.display = 'block';

        // Store FULL invitation URL (not short URL) for copy button - wallets need the complete OOB URL
        document.getElementById('invitationUrlHidden').value = data.invitationUrl;
        document.getElementById('copySection').style.display = 'block';

      } catch (error) {
        console.error('‚ùå Error loading CA invitation:', error);
        document.getElementById('qrcode').innerHTML = '';
        document.getElementById('error').textContent = `Error: ${error.message}`;
        document.getElementById('error').style.display = 'block';
      }
    }

    // Copy invitation URL to clipboard
    function copyInvitationUrl() {
      const invitationUrl = document.getElementById('invitationUrlHidden').value;
      const button = document.getElementById('copyButton');

      navigator.clipboard.writeText(invitationUrl).then(() => {
        // Visual feedback
        button.textContent = '‚úÖ Copied!';
        button.classList.add('copied');

        // Reset button after 2 seconds
        setTimeout(() => {
          button.textContent = 'Copy Invitation URL';
          button.classList.remove('copied');
        }, 2000);

        console.log('‚úÖ Invitation URL copied to clipboard');
      }).catch(err => {
        console.error('‚ùå Failed to copy:', err);
        alert('Failed to copy invitation URL. Please try again.');
      });
    }

    // Load CA invitation on page load
    window.addEventListener('DOMContentLoaded', loadCAInvitation);
  </script>
</body>
</html>
