<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Portal - Certification Authority</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #c31432 0%, #240b36 100%);
            color: white;
            padding: 30px 40px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .user-nav {
            background: #f8f9fa;
            padding: 15px 40px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            color: #240b36;
        }
        
        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            text-decoration: none;
        }
        
        .logout-btn:hover {
            background: #c82333;
        }
        
        .main {
            padding: 40px;
            display: grid;
            gap: 30px;
        }
        
        .section {
            padding: 30px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: #f9f9f9;
        }
        
        .section h2 {
            color: #c31432;
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 2px solid #c31432;
            padding-bottom: 10px;
        }
        
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        .credential-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .id-card {
            background: white;
            color: #333;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .id-header {
            text-align: center;
            border-bottom: 2px solid #c31432;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        
        .id-header h3 {
            color: #c31432;
            font-size: 1.2rem;
        }
        
        .id-body {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }
        
        .id-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.9rem;
        }
        
        .id-info .field {
            padding: 5px 0;
        }
        
        .id-info .label {
            font-weight: 600;
            color: #240b36;
        }
        
        .id-info .value {
            color: #333;
        }
        
        .id-photo {
            background: #f0f0f0;
            border: 2px solid #c31432;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 120px;
            color: #666;
            font-size: 0.9rem;
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .status.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .status.info {
            background: #cce5ff;
            border: 1px solid #b8daff;
            color: #004085;
        }
        
        .session-info {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            font-size: 0.9rem;
        }
        
        .session-info h4 {
            color: #240b36;
            margin-bottom: 10px;
        }
        
        .session-info .detail {
            margin: 5px 0;
            color: #666;
        }
        
        .session-info .detail strong {
            color: #333;
        }
        
        .btn {
            background: linear-gradient(135deg, #c31432 0%, #240b36 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin: 5px;
            transition: transform 0.2s, box-shadow 0.2s;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(195, 20, 50, 0.3);
        }
        
        .btn.secondary {
            background: #6c757d;
        }
        
        .access-denied {
            text-align: center;
            padding: 40px;
        }
        
        .access-denied h2 {
            color: #dc3545;
            margin-bottom: 20px;
        }
        
        .credential-details {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .credential-section {
            margin-bottom: 30px;
        }
        
        .credential-section h4 {
            color: #c31432;
            margin-bottom: 15px;
            font-size: 1.1rem;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 5px;
        }
        
        .claims-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .claim-item {
            background: white;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        
        .claim-label {
            font-weight: 600;
            color: #555;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .claim-value {
            color: #333;
            font-size: 1rem;
            word-break: break-all;
        }
        
        .metadata-info {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        
        .meta-item {
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .meta-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .badge.active {
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <span>üîê</span>
                <span>Secure Portal</span>
            </h1>
            <p>Authenticated Access - Certification Authority</p>
        </div>
        
        <div id="userNav" class="user-nav" style="display: none;">
            <div class="user-info">
                <span>üîê</span>
                <span>Welcome, <strong id="userName"></strong></span>
            </div>
            <button class="logout-btn" onclick="logout()">üö™ Logout</button>
        </div>
        
        <div id="accessDenied" class="main access-denied">
            <h2>üö´ Access Denied</h2>
            <p>You must authenticate with a valid RealPerson credential to access this portal.</p>
            <div style="margin: 20px 0;">
                <a href="/login" class="btn">üîì Login with Credential</a>
                <a href="/" class="btn secondary">‚Üê Back to Main</a>
            </div>
        </div>
        
        <div id="authenticatedContent" class="main" style="display: none;">
            <!-- Welcome Section -->
            <div class="section">
                <h2>üéâ Welcome to the Secure Portal</h2>
                <div class="status success">
                    <strong>‚úÖ Authentication Successful!</strong><br>
                    Your RealPerson credential has been verified using zero-knowledge proofs.
                    Your personal information is displayed below based on your credential claims.
                </div>
            </div>
            
            <!-- Personal Information -->
            <div class="two-column">
                <div class="section">
                    <h2>üÜî Your Identity Information</h2>
                    <p>Information extracted from your verified RealPerson credential:</p>
                    
                    <div class="credential-card">
                        <h3>üÜî RealPerson Identity</h3>
                        <div class="id-card">
                            <div class="id-header">
                                <h3>üèõÔ∏è CERTIFICATION AUTHORITY</h3>
                                <p>Official Identity Credential</p>
                            </div>
                            <div class="id-body">
                                <div class="id-info">
                                    <div class="field">
                                        <div class="label">Full Name:</div>
                                        <div class="value" id="fullName">-</div>
                                    </div>
                                    <div class="field">
                                        <div class="label">Date of Birth:</div>
                                        <div class="value" id="dateOfBirth">-</div>
                                    </div>
                                    <div class="field">
                                        <div class="label">Gender:</div>
                                        <div class="value" id="gender">-</div>
                                    </div>
                                    <div class="field">
                                        <div class="label">Unique ID:</div>
                                        <div class="value" id="uniqueId">-</div>
                                    </div>
                                    <div class="field">
                                        <div class="label">Credential Type:</div>
                                        <div class="value" id="credentialType">-</div>
                                    </div>
                                    <div class="field">
                                        <div class="label">Authentication Method:</div>
                                        <div class="value" id="authMethod">-</div>
                                    </div>
                                </div>
                                <div class="id-photo">
                                    üì∑ Verified Identity
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h2>üìã Detailed Credential Information</h2>
                    <p>Complete information from your presented RealPerson credential:</p>
                    
                    <div class="credential-details">
                        <div class="credential-section">
                            <h4>üÜî Identity Claims</h4>
                            <div class="claims-grid">
                                <div class="claim-item">
                                    <div class="claim-label">First Name:</div>
                                    <div class="claim-value" id="detail-firstName">-</div>
                                </div>
                                <div class="claim-item">
                                    <div class="claim-label">Last Name:</div>
                                    <div class="claim-value" id="detail-lastName">-</div>
                                </div>
                                <div class="claim-item">
                                    <div class="claim-label">Date of Birth:</div>
                                    <div class="claim-value" id="detail-dateOfBirth">-</div>
                                </div>
                                <div class="claim-item">
                                    <div class="claim-label">Gender:</div>
                                    <div class="claim-value" id="detail-gender">-</div>
                                </div>
                                <div class="claim-item">
                                    <div class="claim-label">Unique Identifier:</div>
                                    <div class="claim-value" id="detail-uniqueId">-</div>
                                </div>
                                <div class="claim-item">
                                    <div class="claim-label">Credential Type:</div>
                                    <div class="claim-value" id="detail-credentialType">-</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="credential-section">
                            <h4>üîê Authentication Metadata</h4>
                            <div class="metadata-info">
                                <div class="meta-item">
                                    <strong>Verification Method:</strong> <span id="detail-verificationMethod">-</span>
                                </div>
                                <div class="meta-item">
                                    <strong>Presentation ID:</strong> <span id="detail-presentationId">-</span>
                                </div>
                                <div class="meta-item">
                                    <strong>Session Created:</strong> <span id="detail-loginTime">-</span>
                                </div>
                                <div class="meta-item">
                                    <strong>Authentication Status:</strong> <span class="badge active">‚úÖ Verified</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h2>üîí Session Information</h2>
                    <p>Details about your authenticated session:</p>
                    
                    <div class="session-info">
                        <h4>Authentication Details</h4>
                        <div class="detail"><strong>Connection ID:</strong> <span id="connectionId">-</span></div>
                        <div class="detail"><strong>Presentation ID:</strong> <span id="presentationId">-</span></div>
                        <div class="detail"><strong>Login Time:</strong> <span id="loginTime">-</span></div>
                        <div class="detail"><strong>Authentication Method:</strong> RealPerson Credential Proof</div>
                    </div>
                    
                    <div class="status info">
                        <strong>üîê Privacy Notice:</strong><br>
                        Your personal information is never stored on our servers.
                        All data is extracted in real-time from your verified credential presentation.
                    </div>
                </div>
            </div>
            
            <!-- Available Services -->
            <div class="section">
                <h2>üìã Available Services</h2>
                <p>Services available to authenticated users with RealPerson credentials:</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0;">
                    <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #e0e0e0; text-align: center;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">üîê</div>
                        <h4>Security Clearance</h4>
                        <p style="font-size: 0.9rem; color: #666; margin: 10px 0;">Request security clearance credentials with embedded keypairs</p>
                        <a href="/security-clearance" class="btn" style="text-decoration: none;">Request Clearance</a>
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #e0e0e0; text-align: center;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">üîÑ</div>
                        <h4>Update Profile</h4>
                        <p style="font-size: 0.9rem; color: #666; margin: 10px 0;">Request updates to your identity information</p>
                        <button class="btn secondary" onclick="alert('Profile updates coming soon!')">Update Profile</button>
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #e0e0e0; text-align: center;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">üìä</div>
                        <h4>Usage History</h4>
                        <p style="font-size: 0.9rem; color: #666; margin: 10px 0;">View your authentication and service history</p>
                        <button class="btn secondary" onclick="alert('Usage history coming soon!')">View History</button>
                    </div>
                </div>
            </div>

            <!-- DIDComm Connection Records -->
            <div class="section">
                <h2>üîó DIDComm Connection Records</h2>
                <p>Manage connections and start conversations with connected wallets</p>
                
                <div id="didcommRecords" style="margin-top: 20px;">
                    <div style="display: grid; gap: 15px;">
                        <div style="text-align: center; padding: 2rem; color: #666;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üîç</div>
                            <p>Loading DIDComm connection records...</p>
                        </div>
                    </div>
                </div>
                
                <button class="btn secondary" onclick="loadDIDCommRecords()" style="margin-top: 15px;">üîÑ Refresh Records</button>
            </div>

            <!-- DIDComm Messaging Section -->
            <div class="section" id="messagingSection" style="display: none;">
                <h2>üí¨ DIDComm Chat</h2>
                <div id="chatHeader" style="padding: 15px; background: #e3f2fd; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2196f3;">
                    <h3 style="margin: 0; color: #1976d2;">Chat with Connection</h3>
                    <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9rem;">Secure DIDComm v2 encrypted messaging</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-top: 20px;">
                    <!-- Chat Display -->
                    <div>
                        <div id="chatDisplay" style="height: 400px; border: 2px solid #e0e0e0; border-radius: 8px; padding: 15px; overflow-y: auto; background: white;">
                            <p style="color: #666;">Select a connection to start chatting</p>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <textarea id="chatMessageInput" placeholder="Type your message..." style="width: 100%; height: 60px; padding: 10px; border: 2px solid #e0e0e0; border-radius: 4px; resize: vertical;"></textarea>
                            <div style="margin-top: 10px;">
                                <button class="btn" onclick="sendChatMessage()">üì§ Send Message</button>
                                <button class="btn secondary" onclick="closeChatSession()">‚ùå Close Chat</button>
                            </div>
                        </div>
                        <div id="chatResult" style="margin-top: 10px;"></div>
                    </div>
                    
                    <!-- Chat Info Panel -->
                    <div>
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <h4>Connection Details</h4>
                            <div id="chatConnectionDetails" style="margin-top: 10px;">
                                <p style="color: #666;">No active chat session</p>
                            </div>
                        </div>
                        
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; margin-top: 15px;">
                            <h4>Chat Actions</h4>
                            <button class="btn secondary" onclick="refreshChatMessages()" style="width: 100%; margin-top: 10px;">üîÑ Refresh</button>
                            <button class="btn secondary" onclick="exportChatHistory()" style="width: 100%; margin-top: 10px;">üìÑ Export History</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Base path detection for reverse proxy routing
        const BASE_PATH = window.location.pathname.startsWith('/ca') ? '/ca' : '';
        console.log('[CA] Detected BASE_PATH:', BASE_PATH);

        // Helper function to build API URLs with base path
        function apiUrl(path) {
            return BASE_PATH + path;
        }

        // Check authentication on page load
        window.addEventListener('load', () => {
            checkAuthentication();
        });

        function checkAuthentication() {
            const authData = sessionStorage.getItem('ca_auth');
            
            if (!authData) {
                // Not authenticated - show access denied
                document.getElementById('accessDenied').style.display = 'block';
                return;
            }
            
            try {
                const auth = JSON.parse(authData);
                console.log('üîç [DEBUG] Retrieved auth data from session:', auth);
                console.log('üîç [DEBUG] Personal info retrieved:', auth.personalInfo);
                
                // Check if authentication is recent (within 1 hour)
                const loginTime = new Date(auth.loginTime);
                const now = new Date();
                const hoursSinceLogin = (now - loginTime) / (1000 * 60 * 60);
                
                if (hoursSinceLogin > 1) {
                    // Authentication expired
                    sessionStorage.removeItem('ca_auth');
                    alert('Your session has expired. Please login again.');
                    window.location.href = '/login';
                    return;
                }
                
                // Valid authentication - show portal
                displayAuthenticatedPortal(auth);
                
            } catch (error) {
                console.error('Error parsing authentication data:', error);
                sessionStorage.removeItem('ca_auth');
                document.getElementById('accessDenied').style.display = 'block';
            }
        }

        function displayAuthenticatedPortal(authData) {
            // Hide access denied and show authenticated content
            document.getElementById('accessDenied').style.display = 'none';
            document.getElementById('authenticatedContent').style.display = 'block';
            document.getElementById('userNav').style.display = 'flex';
            
            // Display personal information from credential
            const personalInfo = authData.personalInfo || {};
            
            document.getElementById('userName').textContent = 
                `${personalInfo.firstName || ''} ${personalInfo.lastName || ''}`.trim() || 'User';
            
            document.getElementById('fullName').textContent = 
                `${personalInfo.firstName || ''} ${personalInfo.lastName || ''}`.trim();
            
            document.getElementById('dateOfBirth').textContent = personalInfo.dateOfBirth || '-';
            document.getElementById('gender').textContent = personalInfo.gender || '-';
            document.getElementById('uniqueId').textContent = personalInfo.uniqueId || '-';
            document.getElementById('credentialType').textContent = personalInfo.type || 'RealPerson';
            document.getElementById('authMethod').textContent = authData.verificationMethod || 'QR-Code';
            
            // Display session information
            document.getElementById('connectionId').textContent = 
                (authData.connectionId || '').substring(0, 16) + '...';
            
            document.getElementById('presentationId').textContent = 
                (authData.presentationId || '').substring(0, 16) + '...';
            
            document.getElementById('loginTime').textContent = 
                new Date(authData.loginTime).toLocaleString();
            
            // Populate detailed credential information
            document.getElementById('detail-firstName').textContent = personalInfo.firstName || '-';
            document.getElementById('detail-lastName').textContent = personalInfo.lastName || '-';
            document.getElementById('detail-dateOfBirth').textContent = personalInfo.dateOfBirth || '-';
            document.getElementById('detail-gender').textContent = personalInfo.gender || '-';
            document.getElementById('detail-uniqueId').textContent = personalInfo.uniqueId || '-';
            document.getElementById('detail-credentialType').textContent = personalInfo.type || 'RealPerson';
            document.getElementById('detail-verificationMethod').textContent = authData.verificationMethod || 'QR-Code Credential Presentation';
            document.getElementById('detail-presentationId').textContent = authData.presentationId || '-';
            document.getElementById('detail-loginTime').textContent = new Date(authData.loginTime).toLocaleString();
        }

        function logout() {
            // Clear session data
            sessionStorage.removeItem('ca_auth');
            
            // Redirect to login page
            alert('You have been logged out successfully.');
            window.location.href = '/login';
        }

        // Auto-logout after 1 hour of inactivity
        let inactivityTimer;
        
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                alert('Session expired due to inactivity.');
                logout();
            }, 60 * 60 * 1000); // 1 hour
        }
        
        // Reset timer on user activity
        document.addEventListener('click', resetInactivityTimer);
        document.addEventListener('keypress', resetInactivityTimer);
        document.addEventListener('scroll', resetInactivityTimer);
        
        // Start inactivity timer
        resetInactivityTimer();

        // DIDComm Messaging Functions
        let messages = [];
        let connections = [];
        let currentChatConnection = null;
        let chatMessages = [];

        // Load DIDComm connection records from Cloud Agent
        async function loadDIDCommRecords() {
            try {
                const recordsDiv = document.getElementById('didcommRecords');
                recordsDiv.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">‚è≥</div>
                        <p>Loading DIDComm connection records from Cloud Agent...</p>
                    </div>
                `;

                // Fetch connections from Cloud Agent
                const response = await fetch(apiUrl('/api/cloud-agent/connections'));
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                connections = data.contents || [];
                
                if (connections.length === 0) {
                    recordsDiv.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #666;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üîó</div>
                            <h3>No DIDComm Connections Found</h3>
                            <p>No active DIDComm connections available for messaging.</p>
                            <p style="margin-top: 1rem;"><em>Connections will appear here once wallets establish DIDComm connections with the CA.</em></p>
                        </div>
                    `;
                    return;
                }
                
                // Display connection records
                recordsDiv.innerHTML = `
                    <div style="display: grid; gap: 15px;">
                        ${connections.map(conn => `
                            <div style="background: white; border: 2px solid #e0e0e0; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                                    <div>
                                        <h3 style="margin: 0 0 8px 0; color: #333;">
                                            üîó ${conn.label || 'Unnamed Connection'}
                                        </h3>
                                        <div style="display: flex; gap: 15px; flex-wrap: wrap; font-size: 0.9rem; color: #666;">
                                            <span><strong>ID:</strong> ${conn.connectionId.substring(0, 12)}...</span>
                                            <span><strong>State:</strong> <span class="badge ${getConnectionStateClass(conn.state)}">${conn.state}</span></span>
                                            <span><strong>Role:</strong> ${conn.role || 'Unknown'}</span>
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 10px;">
                                        <button class="btn" onclick="openChatWithConnection('${conn.connectionId}', '${conn.label || 'Unnamed Connection'}', '${conn.state}')" style="padding: 8px 16px; font-size: 0.9rem;">
                                            üí¨ Start Chat
                                        </button>
                                        <button class="btn secondary" onclick="viewConnectionDetails('${conn.connectionId}')" style="padding: 8px 16px; font-size: 0.9rem;">
                                            üîç Details
                                        </button>
                                    </div>
                                </div>
                                
                                <div style="padding: 12px; background: #f8f9fa; border-radius: 8px; font-size: 0.85rem;">
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                                        <div><strong>Created:</strong> ${conn.createdAt ? new Date(conn.createdAt).toLocaleDateString() : 'Unknown'}</div>
                                        <div><strong>Updated:</strong> ${conn.updatedAt ? new Date(conn.updatedAt).toLocaleDateString() : 'Unknown'}</div>
                                        <div><strong>Thread ID:</strong> ${conn.thid ? conn.thid.substring(0, 8) + '...' : 'N/A'}</div>
                                        <div><strong>Protocol:</strong> DIDComm v2.0</div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading DIDComm records:', error);
                document.getElementById('didcommRecords').innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem; color: #dc3545;">‚ùå</div>
                        <h3 style="color: #dc3545;">Error Loading Records</h3>
                        <p style="color: #666;">Failed to load DIDComm connection records from Cloud Agent.</p>
                        <p style="font-size: 0.9rem; color: #999; margin-top: 1rem;">Error: ${error.message}</p>
                        <button class="btn secondary" onclick="loadDIDCommRecords()" style="margin-top: 15px;">üîÑ Retry</button>
                    </div>
                `;
            }
        }

        function getConnectionStateClass(state) {
            switch(state) {
                case 'ConnectionResponseReceived':
                case 'ConnectionResponseSent': 
                    return 'active';
                case 'InvitationGenerated':
                case 'ConnectionRequestPending':
                    return 'pending';
                default:
                    return 'pending';
            }
        }

        // Open chat with a specific connection
        async function openChatWithConnection(connectionId, connectionLabel, connectionState) {
            try {
                currentChatConnection = {
                    id: connectionId,
                    label: connectionLabel,
                    state: connectionState
                };
                
                // Show messaging section
                document.getElementById('messagingSection').style.display = 'block';
                
                // Scroll to messaging section
                document.getElementById('messagingSection').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
                
                // Update chat header
                document.getElementById('chatHeader').innerHTML = `
                    <h3 style="margin: 0; color: #1976d2;">üí¨ Chat with ${connectionLabel}</h3>
                    <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9rem;">
                        üîó Connection: ${connectionId.substring(0, 12)}... | 
                        üì° State: ${connectionState} | 
                        üîê DIDComm v2 Encrypted
                    </p>
                `;
                
                // Update connection details panel
                document.getElementById('chatConnectionDetails').innerHTML = `
                    <div style="font-size: 0.9rem;">
                        <p><strong>Connection:</strong><br>${connectionLabel}</p>
                        <p><strong>ID:</strong><br>${connectionId.substring(0, 20)}...</p>
                        <p><strong>State:</strong><br><span class="badge ${getConnectionStateClass(connectionState)}">${connectionState}</span></p>
                        <p><strong>Protocol:</strong><br>DIDComm v2.0</p>
                    </div>
                `;
                
                // Load existing chat history for this connection
                await loadChatHistory(connectionId, connectionLabel);
                
                // Focus message input
                document.getElementById('chatMessageInput').focus();
                
            } catch (error) {
                console.error('Error opening chat:', error);
                alert('Failed to open chat: ' + error.message);
            }
        }

        async function loadChatHistory(connectionId, connectionLabel) {
            // Filter messages for this specific connection
            const connectionMessages = messages.filter(msg => 
                (msg.sender === connectionLabel || msg.recipient === connectionLabel) ||
                (msg.sender === 'Certification Authority' && msg.recipient.includes(connectionLabel)) ||
                (msg.recipient === 'Certification Authority' && msg.sender.includes(connectionLabel))
            );
            
            chatMessages = connectionMessages;
            updateChatDisplay();
        }

        function updateChatDisplay() {
            const display = document.getElementById('chatDisplay');
            if (chatMessages.length === 0) {
                display.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #666;">
                        <div style="font-size: 2.5rem; margin-bottom: 1rem;">üí¨</div>
                        <h4>Start a Conversation</h4>
                        <p>No messages yet with this connection.</p>
                        <p style="font-size: 0.9rem; margin-top: 1rem;">Messages are end-to-end encrypted using DIDComm v2.0</p>
                    </div>
                `;
            } else {
                const sortedMessages = chatMessages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                display.innerHTML = sortedMessages.map(msg => `
                    <div style="margin-bottom: 15px; padding: 12px; border-radius: 12px; background: ${msg.direction === 'sent' ? '#e3f2fd' : '#f3e5f5'}; border-left: 4px solid ${msg.direction === 'sent' ? '#2196f3' : '#9c27b0'};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-weight: bold; color: ${msg.direction === 'sent' ? '#1976d2' : '#7b1fa2'};">
                                ${msg.direction === 'sent' ? 'üì§ You (CA)' : 'üì• ' + msg.sender}
                            </span>
                            <span style="font-size: 0.75rem; color: #666;">${new Date(msg.timestamp).toLocaleString()}</span>
                        </div>
                        <div style="line-height: 1.4;">${msg.content}</div>
                    </div>
                `).join('');
                display.scrollTop = display.scrollHeight;
            }
        }

        async function sendChatMessage() {
            if (!currentChatConnection) {
                alert('Please select a connection first');
                return;
            }
            
            const messageText = document.getElementById('chatMessageInput').value.trim();
            if (!messageText) {
                alert('Please enter a message');
                return;
            }
            
            try {
                const result = document.getElementById('chatResult');
                result.innerHTML = '<div style="padding: 8px; background: #d1ecf1; border-radius: 4px; color: #0c5460; font-size: 0.9rem;">Sending message...</div>';

                // Create message
                const message = {
                    type: 'https://didcomm.org/basicmessage/2.0/message',
                    id: Date.now().toString(),
                    created_time: new Date().toISOString(),
                    from: 'Certification Authority',
                    to: currentChatConnection.label,
                    body: {
                        content: messageText
                    }
                };

                // Add to local chat messages
                const chatMessage = {
                    id: message.id,
                    timestamp: new Date().toISOString(),
                    direction: 'sent',
                    content: messageText,
                    sender: 'Certification Authority',
                    recipient: currentChatConnection.label
                };
                
                chatMessages.push(chatMessage);
                messages.push(chatMessage);

                // Send to wallet (attempt delivery)
                let deliverySuccess = false;
                if (currentChatConnection.label.includes('Alice') || currentChatConnection.label.toLowerCase().includes('alice')) {
                    try {
                        const deliveryResponse = await fetch('http://localhost:3010/api/receive-didcomm-message', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                from: 'Certification Authority',
                                message: message,
                                relayedBy: 'ca-portal'
                            })
                        });
                        deliverySuccess = deliveryResponse.ok;
                    } catch (error) {
                        console.error('Delivery failed:', error);
                    }
                }

                result.innerHTML = deliverySuccess 
                    ? '<div style="padding: 8px; background: #d4edda; border-radius: 4px; color: #155724; font-size: 0.9rem;">‚úÖ Message sent and delivered</div>'
                    : '<div style="padding: 8px; background: #fff3cd; border-radius: 4px; color: #856404; font-size: 0.9rem;">üì§ Message sent (delivery pending)</div>';
                
                document.getElementById('chatMessageInput').value = '';
                updateChatDisplay();
                
                // Clear result after delay
                setTimeout(() => {
                    result.innerHTML = '';
                }, 3000);
                
            } catch (error) {
                document.getElementById('chatResult').innerHTML = 
                    '<div style="padding: 8px; background: #f8d7da; border-radius: 4px; color: #721c24; font-size: 0.9rem;">‚ùå Error: ' + error.message + '</div>';
            }
        }

        function closeChatSession() {
            currentChatConnection = null;
            chatMessages = [];
            document.getElementById('messagingSection').style.display = 'none';
        }

        function refreshChatMessages() {
            if (currentChatConnection) {
                loadChatHistory(currentChatConnection.id, currentChatConnection.label);
            }
        }

        function exportChatHistory() {
            if (chatMessages.length === 0) {
                alert('No chat history to export');
                return;
            }
            
            const chatData = {
                connection: currentChatConnection,
                messages: chatMessages,
                exportedAt: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(chatData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat-history-${currentChatConnection.label.replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function viewConnectionDetails(connectionId) {
            const connection = connections.find(c => c.connectionId === connectionId);
            if (!connection) {
                alert('Connection not found');
                return;
            }
            
            alert(`Connection Details:\n\nID: ${connection.connectionId}\nLabel: ${connection.label || 'Unnamed'}\nState: ${connection.state}\nRole: ${connection.role || 'Unknown'}\nCreated: ${connection.createdAt || 'Unknown'}\nUpdated: ${connection.updatedAt || 'Unknown'}\nThread ID: ${connection.thid || 'N/A'}`);
        }

        async function sendMessage() {
            try {
                const recipient = document.getElementById('recipientSelect').value;
                const messageText = document.getElementById('messageInput').value.trim();
                
                if (!recipient) {
                    alert('Please select a recipient');
                    return;
                }
                
                if (!messageText) {
                    alert('Please enter a message');
                    return;
                }

                const result = document.getElementById('messageResult');
                result.innerHTML = '<div style="padding: 10px; background: #d1ecf1; border-radius: 4px; color: #0c5460;">Sending message...</div>';

                // Create DIDComm message
                const message = {
                    type: 'https://didcomm.org/basicmessage/2.0/message',
                    id: Date.now().toString(),
                    created_time: new Date().toISOString(),
                    from: 'Certification Authority',
                    to: recipient,
                    body: {
                        content: messageText
                    }
                };

                // Store message locally
                messages.push({
                    id: message.id,
                    timestamp: new Date(),
                    direction: 'sent',
                    content: messageText,
                    sender: 'Certification Authority',
                    recipient: recipient
                });

                // Send to recipient wallet
                let success = false;
                if (recipient.includes('Alice') || recipient.includes('alice')) {
                    try {
                        const response = await fetch('http://localhost:3010/api/receive-didcomm-message', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                from: 'Certification Authority',
                                message: message,
                                relayedBy: 'ca-portal'
                            })
                        });
                        success = response.ok;
                    } catch (error) {
                        console.error('Failed to deliver to Alice:', error);
                    }
                }

                result.innerHTML = success 
                    ? '<div style="padding: 10px; background: #d4edda; border-radius: 4px; color: #155724;">‚úÖ Message sent successfully!</div>'
                    : '<div style="padding: 10px; background: #f8d7da; border-radius: 4px; color: #721c24;">‚ö†Ô∏è Message sent but delivery confirmation failed</div>';
                
                document.getElementById('messageInput').value = '';
                updateMessageDisplay();
                
            } catch (error) {
                document.getElementById('messageResult').innerHTML = 
                    '<div style="padding: 10px; background: #f8d7da; border-radius: 4px; color: #721c24;">‚ùå Error: ' + error.message + '</div>';
            }
        }

        async function refreshMessages() {
            try {
                // Fetch messages from CA server
                const response = await fetch(apiUrl('/api/receive-didcomm-messages'));
                if (response.ok) {
                    const data = await response.json();
                    if (data.messages && data.messages.length > 0) {
                        data.messages.forEach(msg => {
                            if (!messages.find(m => m.id === msg.id)) {
                                messages.push({
                                    id: msg.id,
                                    timestamp: new Date(msg.timestamp),
                                    direction: 'received',
                                    content: msg.content,
                                    sender: msg.sender || 'Unknown',
                                    recipient: 'Certification Authority'
                                });
                            }
                        });
                    }
                }
                updateMessageDisplay();
            } catch (error) {
                console.error('Error refreshing messages:', error);
            }
        }

        function updateMessageDisplay() {
            const display = document.getElementById('messageDisplay');
            if (messages.length === 0) {
                display.innerHTML = '<p style="color: #666;">No messages yet. Messages from connected wallets will appear here.</p>';
            } else {
                const sortedMessages = messages.sort((a, b) => a.timestamp - b.timestamp);
                display.innerHTML = sortedMessages.map(msg => `
                    <div style="margin-bottom: 15px; padding: 12px; border-radius: 8px; background: ${msg.direction === 'sent' ? '#e3f2fd' : '#f3e5f5'}; border-left: 4px solid ${msg.direction === 'sent' ? '#2196f3' : '#9c27b0'};">
                        <div style="font-weight: bold; color: ${msg.direction === 'sent' ? '#1976d2' : '#7b1fa2'}; margin-bottom: 5px;">
                            ${msg.direction === 'sent' ? 'üì§ You ‚Üí ' + msg.recipient : 'üì• ' + msg.sender + ' ‚Üí You'}
                        </div>
                        <div style="margin-bottom: 8px;">${msg.content}</div>
                        <div style="font-size: 0.8rem; color: #666;">${msg.timestamp.toLocaleString()}</div>
                    </div>
                `).join('');
                display.scrollTop = display.scrollHeight;
            }
        }

        async function loadConnections() {
            try {
                // Simulate CA connections - in production, would fetch from Cloud Agent
                connections = [
                    { id: '1', label: 'Alice Johnson (Software Engineer)', state: 'ConnectionResponseReceived' }
                ];
                
                // Update recipient dropdown
                const select = document.getElementById('recipientSelect');
                select.innerHTML = '<option value="">Select connected wallet...</option>';
                connections.forEach(conn => {
                    const option = document.createElement('option');
                    option.value = conn.label;
                    option.textContent = conn.label;
                    select.appendChild(option);
                });

                // Update connection list
                const list = document.getElementById('connectionList');
                if (connections.length === 0) {
                    list.innerHTML = '<p style="color: #666;">No active connections found.</p>';
                } else {
                    list.innerHTML = connections.map(conn => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; margin: 5px 0; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">
                            <span><strong>${conn.label}</strong></span>
                            <span style="padding: 2px 8px; background: #28a745; color: white; border-radius: 12px; font-size: 0.8rem;">Active</span>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading connections:', error);
            }
        }

        // Initialize messaging when authentication is successful
        function initializeMessaging() {
            loadConnections();
            refreshMessages();
            loadDIDCommRecords(); // Load DIDComm connection records
            // Set up periodic refresh
            setInterval(refreshMessages, 10000); // Refresh every 10 seconds
            setInterval(loadDIDCommRecords, 30000); // Refresh connection records every 30 seconds
        }

        // Modify the authentication check to initialize messaging
        const originalDisplayAuthenticatedUser = displayAuthenticatedUser;
        function displayAuthenticatedUser(userData) {
            originalDisplayAuthenticatedUser(userData);
            initializeMessaging();
        }
    </script>
</body>
</html>